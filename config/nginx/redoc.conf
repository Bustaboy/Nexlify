# config/nginx/redoc.conf
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# NEXLIFY API DOCUMENTATION - NEURAL INTERFACE MANUAL
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ReDoc-powered API documentation with cyberpunk theming
# Interactive OpenAPI spec viewer for code jockeys and netrunners

server {
    listen ${DOCS_PORT:-8080};
    listen [::]:${DOCS_PORT:-8080};
    server_name ${DOCS_DOMAIN};
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # SECURITY - Docs are public but protected
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    # Security headers for documentation
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' ${API_DOMAIN};" always;
    
    # Rate limiting for docs (lighter than API)
    limit_req zone=general burst=20 nodelay;
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ROOT - Redirect to API docs
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location = / {
        return 301 /api-docs;
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # API DOCUMENTATION - ReDoc interface
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location /api-docs {
        root /usr/share/nginx/html;
        try_files /redoc.html /index.html =404;
        
        # Cache control for static assets
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # Static ReDoc HTML with cyberpunk theme
    location = /redoc.html {
        root /usr/share/nginx/html;
        default_type text/html;
        
        # Inline ReDoc with custom theme
        return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexlify Trading Matrix - API Neural Interface</title>
    <meta name="description" content="Technical documentation for the Nexlify algorithmic trading API">
    
    <!-- ReDoc doesn\'t have integrity attributes in their CDN -->
    <script src="https://cdn.jsdelivr.net/npm/redoc@2.1.5/bundles/redoc.standalone.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            font-family: "Consolas", "Monaco", monospace;
        }
        
        /* Cyberpunk theme overrides */
        .api-content {
            background: #0a0a0a !important;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00ff9f;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00cc7f;
        }
        
        /* Loading screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: monospace;
            color: #00ff9f;
            font-size: 1.5em;
        }
        
        #loading::after {
            content: "Initializing neural interface...";
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="loading"></div>
    <div id="redoc-container"></div>
    
    <script>
        // Cyberpunk theme configuration
        const theme = {
            colors: {
                primary: {
                    main: "#00ff9f",
                    light: "#00ffcc",
                    dark: "#00cc7f",
                    contrastText: "#0a0a0a"
                },
                success: {
                    main: "#00ff9f",
                    light: "#00ffcc",
                    dark: "#00cc7f"
                },
                warning: {
                    main: "#ff9f00",
                    light: "#ffb333",
                    dark: "#cc7f00"
                },
                error: {
                    main: "#ff0040",
                    light: "#ff3366",
                    dark: "#cc0033"
                },
                text: {
                    primary: "#e0e0e0",
                    secondary: "#a0a0a0"
                },
                border: {
                    dark: "#333333",
                    light: "#555555"
                },
                responses: {
                    success: {
                        color: "#00ff9f",
                        backgroundColor: "rgba(0, 255, 159, 0.1)"
                    },
                    error: {
                        color: "#ff0040",
                        backgroundColor: "rgba(255, 0, 64, 0.1)"
                    },
                    redirect: {
                        color: "#ff9f00",
                        backgroundColor: "rgba(255, 159, 0, 0.1)"
                    },
                    info: {
                        color: "#00ccff",
                        backgroundColor: "rgba(0, 204, 255, 0.1)"
                    }
                }
            },
            typography: {
                fontSize: "16px",
                lineHeight: "1.6",
                fontFamily: "\"Consolas\", \"Monaco\", \"Courier New\", monospace",
                headings: {
                    fontFamily: "\"Orbitron\", \"Consolas\", monospace",
                    fontWeight: "700"
                },
                code: {
                    fontSize: "14px",
                    fontFamily: "\"Fira Code\", \"Consolas\", monospace",
                    backgroundColor: "#1a1a1a",
                    color: "#00ff9f"
                }
            },
            sidebar: {
                backgroundColor: "#0f0f0f",
                textColor: "#e0e0e0",
                activeTextColor: "#00ff9f",
                groupItems: {
                    textTransform: "uppercase"
                },
                level1Items: {
                    textTransform: "none"
                },
                arrow: {
                    size: "1.5em",
                    color: "#00ff9f"
                }
            },
            rightPanel: {
                backgroundColor: "#0a0a0a"
            }
        };
        
        // Initialize ReDoc
        Redoc.init(
            "${OPENAPI_SPEC_URL:-/openapi.json}",
            {
                theme: theme,
                nativeScrollbars: false,
                scrollYOffset: 0,
                hideDownloadButton: ${HIDE_DOWNLOAD_BUTTON:-false},
                disableSearch: ${DISABLE_SEARCH:-false},
                noAutoAuth: ${NO_AUTO_AUTH:-false},
                pathInMiddlePanel: true,
                requiredPropsFirst: true,
                sortPropsAlphabetically: false,
                showExtensions: true,
                hideSingleRequestSampleTab: false,
                jsonSampleExpandLevel: 2,
                payloadSampleIdx: 0,
                expandResponses: "200,201",
                onlyRequiredInSamples: false
            },
            document.getElementById("redoc-container"),
            function() {
                // Hide loading screen
                document.getElementById("loading").style.display = "none";
            }
        );
    </script>
</body>
</html>';
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # OPENAPI SPECIFICATION - Proxied from API
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location = /openapi.json {
        proxy_pass http://nexlify_backend/openapi.json;
        
        # Cache the spec for performance
        proxy_cache_valid 200 5m;
        proxy_cache_use_stale error timeout updating;
        
        # CORS headers for spec access
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        
        # Compression for large specs
        gzip on;
        gzip_types application/json;
    }
    
    # Alternative spec formats
    location = /openapi.yaml {
        proxy_pass http://nexlify_backend/openapi.yaml;
        proxy_cache_valid 200 5m;
        add_header Access-Control-Allow-Origin "*" always;
        gzip on;
        gzip_types application/x-yaml text/yaml;
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # SWAGGER UI - Alternative documentation
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location /swagger {
        alias /usr/share/nginx/html/swagger-ui;
        try_files $uri $uri/ /swagger/index.html;
        
        # Security for Swagger UI
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;" always;
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # POSTMAN COLLECTION - For testing
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location = /postman-collection.json {
        proxy_pass http://nexlify_backend/postman-collection.json;
        add_header Content-Type "application/json";
        add_header Content-Disposition "attachment; filename=\"nexlify-api-collection.json\"";
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # STATIC ASSETS - Logos, custom CSS, etc.
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location /assets/ {
        root /usr/share/nginx/html;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Asset security
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # HEALTH CHECK - Simple endpoint for monitoring
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "API docs neural interface online\n";
    }
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ERROR PAGES - Custom error responses
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    error_page 404 /404.html;
    location = /404.html {
        internal;
        default_type text/html;
        return 404 '<html>
<head>
    <title>404 - Neural Pathway Not Found</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff9f;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .error {
            text-align: center;
        }
        h1 {
            font-size: 4em;
            margin: 0;
            text-shadow: 0 0 20px #00ff9f;
        }
        p {
            font-size: 1.5em;
            opacity: 0.8;
        }
        a {
            color: #00ff9f;
            text-decoration: none;
            border-bottom: 1px solid #00ff9f;
        }
    </style>
</head>
<body>
    <div class="error">
        <h1>404</h1>
        <p>Neural pathway disconnected</p>
        <p><a href="/api-docs">Jack back into the docs</a></p>
    </div>
</body>
</html>';
    }
}
