# config/valkey/valkey.conf
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# NEXLIFY CACHE MATRIX - VALKEY 8.1 CONFIGURATION
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Optimized for high-frequency cryptocurrency trading
# 37% faster than Redis 8.0, 60% better p99 latencies
# Open source rebel tech - no corpo chains
# 
# "In Night City, you're either fast or you're flatlined." - V
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

################################ NEURAL NETWORK ################################

# Bind to container network - never expose to the wild
# Default: bind 127.0.0.1 ::1
bind 0.0.0.0 ::

# Protected mode off - we handle security at container level
protected-mode no

# Neural interface port - same as Redis for compatibility
port 6379

# TCP listen backlog - queue for pending connections
tcp-backlog 2048

# Keep connections alive but not forever - 30s sweet spot for trading
timeout 30
tcp-keepalive 30

################################ CYBERDECK MODES ################################

# Run as daemon in production, foreground for dev
daemonize no

# Process ID file for daemon mode
pidfile /var/run/valkey.pid

# Log level - info for production, debug for troubleshooting
# Options: debug, verbose, notice, warning
loglevel notice

# Log file location - send to stdout for container logs
logfile ""

# Enhanced observability in Valkey 8.1
# Log format: default, json, logfmt
log-format json

# Timestamp format: default, iso8601, unix-ms
log-timestamp-format iso8601

# Number of databases - keep it lean for performance
databases 16

################################ PERSISTENCE MATRIX ################################

# RDB snapshots - checkpoint saves for disaster recovery
save 900 1      # After 900s (15min) if at least 1 key changed
save 300 10     # After 300s (5min) if at least 10 keys changed  
save 60 10000   # After 60s if at least 10000 keys changed

# Stop accepting writes if last background save failed
stop-writes-on-bgsave-error yes

# Compress RDB files - trading space for CPU
rdbcompression yes

# Checksum RDB files - data integrity over speed
rdbchecksum yes

# RDB filename
dbfilename nexlify-cache.rdb

# Working directory for RDB and AOF files
dir /data

################################ NEURAL REPLICATION ################################

# Replica configuration (if running replicas)
# replicaof <masterip> <masterport>

# Replica authentication
# masterauth <master-password>

# Replica serve stale data during sync
replica-serve-stale-data yes

# Replica read-only mode
replica-read-only yes

# Replication sync strategy
repl-diskless-sync yes
repl-diskless-sync-delay 5
repl-diskless-sync-max-replicas 0

# Replication timeout
repl-timeout 60

# Disable TCP_NODELAY on replica socket
repl-disable-tcp-nodelay no

# Replication backlog for partial resync
repl-backlog-size 64mb
repl-backlog-ttl 3600

################################ CYBERWARE SECURITY ################################

# Access Control List (ACL) - Night City style authentication
# Default user gets limited access
user default on ~* &* -@dangerous +@read +@write +@connection

# Trading bot user with full access (password from env)
# Will be set via CONFIG SET at runtime with actual password
# user nexlify-bot on ~* &* +@all

# Require password for default user (set via CONFIG SET)
# requirepass will-be-set-at-runtime

################################ MEMORY MANAGEMENT ################################

# Max memory limit - leave room for OS and other services
# Set via environment variable in production
maxmemory ${VALKEY_MAX_MEMORY:-4gb}

# Memory eviction policy for when limit is reached
# allkeys-lru: Remove least recently used keys
maxmemory-policy allkeys-lru

# Memory sampling size for LRU eviction
maxmemory-samples 5

# Reserved memory for replicas
replica-ignore-maxmemory yes

################################ NEURAL THREADING ################################

# I/O threads - Valkey 8.1 supports up to 256!
# Match CPU cores for RTX 2070 systems (typically 8-16 cores)
io-threads ${VALKEY_IO_THREADS:-8}

# Enable reads via I/O threads
io-threads-do-reads yes

# CPU affinity for I/O threads (optional)
# io-threads-cpu-affinity 1,3,5,7,9,11,13,15

################################ PERSISTENCE OPTIMIZATION ################################

# Append Only File (AOF) - transaction log for durability
appendonly yes

# AOF filename 
appendfilename "nexlify-transactions.aof"

# AOF directory (inside main dir)
appenddirname "appendonlydir"

# AOF fsync policy
# everysec: fsync every second (balanced)
# always: fsync after every write (slow but safe)
# no: let OS handle fsyncing (fast but risky)
appendfsync everysec

# Don't fsync during rewrites
no-appendfsync-on-rewrite no

# Auto rewrite AOF when it grows
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated file
aof-load-truncated yes

# AOF rewrite uses RDB preamble for faster loading
aof-use-rdb-preamble yes

# AOF timestamp for better debugging
aof-timestamp-enabled yes

################################ CYBERSPACE CLUSTERING ################################

# Cluster mode disabled by default (single instance)
# cluster-enabled no

# Cluster config file
# cluster-config-file nodes.conf

# Cluster node timeout
# cluster-node-timeout 15000

################################ PERFORMANCE TUNING ################################

# Slow log for performance debugging
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100
latency-tracking yes
latency-tracking-info-percentiles 50 99 99.9

# Hash table settings - optimized for trading data
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List settings
list-max-listpack-size -2
list-compress-depth 0

# Set settings  
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Sorted set settings
zset-max-listpack-entries 128
zset-max-listpack-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol buffer limit
proto-max-bulk-len 512mb

# Frequency of rehashing the main dictionary
hz 10

# Enable dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB saves incremental fsync
rdb-save-incremental-fsync yes

################################ DEFRAG CONFIGURATION ################################

# Active defragmentation in Valkey 8.1 with anti-starvation
activedefrag yes

# Minimum percentage of fragmentation to start defrag
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10

# Maximum percentage of fragmentation to force defrag
active-defrag-threshold-upper 100

# Minimal effort to defrag in CPU percentage
active-defrag-cycle-min 1

# Maximal effort to defrag in CPU percentage
active-defrag-cycle-max 25

# Jemalloc background thread for purging
jemalloc-bg-thread yes

################################ TLS/SSL ENCRYPTION ################################

# Enable TLS - critical for trading security
tls-port 6380

# Certificate and key files (mount from secrets)
tls-cert-file /tls/valkey.crt
tls-key-file /tls/valkey.key
tls-ca-cert-file /tls/ca.crt
tls-dh-params-file /tls/valkey.dh

# TLS protocols - only modern crypto
tls-protocols "TLSv1.2 TLSv1.3"

# Cipher suite - AEAD ciphers only
tls-ciphers "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"

# Prefer server cipher order
tls-prefer-server-ciphers yes

# Session caching
tls-session-caching no
tls-session-cache-timeout 60

# Mutual TLS for client auth
tls-auth-clients no

################################ RDMA SUPPORT ################################

# Remote Direct Memory Access - for ultra-low latency
# Requires RDMA-capable hardware and drivers
# rdma-port 6389

################################ MODULES ################################

# Valkey 8.1 modules - enable as needed
# Search module for vector similarity (AI trading signals)
# loadmodule /opt/valkey/modules/valkey-search.so

# JSON module for complex trading data
# loadmodule /opt/valkey/modules/valkey-json.so

# Bloom filter module for duplicate detection
# loadmodule /opt/valkey/modules/valkey-bloom.so

################################ ADVANCED SETTINGS ################################

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG-e4b51c73"

# Enable keyspace notifications for cache invalidation
notify-keyspace-events "Ex"

# Stop writes on low memory
stop-writes-on-oom-error yes

# Background tasks
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threaded I/O for lazyfree
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# Sanitize dump payload
sanitize-dump-payload yes

# Crash log
crash-log-enabled yes
crash-memcheck-enabled yes

# Watchdog
watchdog-period 0

# Shutdown options
shutdown-timeout 10
shutdown-on-sigint default
shutdown-on-sigterm default

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# "Time to jack in and make some eddies!" - Jackie Welles
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
